# RTFM-Sovereign TEE Specification

## TEE Architecture Overview

RTFM-Sovereign uses Trusted Execution Environments (TEEs) via Intel SGX enclaves to provide verifiable, confidential computation for skill verification. This ensures that challenge grading occurs in a secure, tamper-proof environment.

### TEE Stack

```
┌─────────────────────────────────────────────────────────┐
│              EigenCompute Infrastructure              │
├─────────────────────────────────────────────────────────┤
│  Host OS (Linux)                               │
│    │                                               │
│    ▼                                               │
│  ┌─────────────┐                                 │
│  │  Gramine    │   LibOS for SGX               │
│  │  (User Mode)│                                  │
│  └──────┬──────┘                                 │
│         │                                          │
│         ▼                                          │
│  ┌─────────────┐                                 │
│  │  SGX Enclave│  Secure Memory (EPC)       │
│  │  (Privileged)│                                  │
│  │                                                     │
│  │  - Agent Logic                                    │
│  │  - Private Keys                                  │
│  │  - ECDSA Signing                                 │
│  │                                                     │
│  └─────────────┘                                 │
│                                                   │
└─────────────────────────────────────────────────────────┘
```

### Components

1. **Host OS**: Linux runtime providing system resources
2. **Gramine**: Library Operating System (LibOS) enabling SGX enclaves for unmodified applications
3. **SGX Enclave**: Secure memory region protected by CPU hardware
4. **Agent Logic**: Challenge grading and signing operations

---

## Security Properties

### 1. Confidentiality

**Property**: Code and data inside enclave cannot be dumped by host OS.

**Implementation:**
- All private keys (TEE signing key) generated inside enclave
- Keys sealed to SGX sealing key (unsealable only by same enclave)
- Host cannot access enclave memory even with root access

**Guarantee**: Even if EigenCompute infrastructure is compromised, private keys remain secure.

### 2. Integrity

**Property**: Remote attestation proves code hasn't been modified.

**Implementation:**
- Enclave generates SGX Quote on startup
- Quote includes measurement hash (hash of loaded code)
- Measurement hash compared to expected value during verification

**Verification Flow:**
```
Enclave Startup
  ↓
Generate SGX Quote (includes measurement)
  ↓
Send to Verifier (Smart Contract or Oracle)
  ↓
Verify Measurement == Expected Hash
  ↓
Accept as Authentic TEE
```

**Guarantee**: If TEE code is modified, measurement changes and attestation fails.

### 3. Attestation Flow

**Local Attestation (Startup)**
1. Enclave generates key pair (private sealed, public exported)
2. Enclave creates SGX Quote proving measurement
3. Quote signed by Intel's attestation service
4. Public key + Quote sent to smart contract for enrollment

**Per-Request Attestation (Operation)**
1. Web sends challenge answer to TEE
2. Enclave executes grading logic
3. Enclave signs score with private key
4. Signature + score returned to web

**On-Chain Verification**
1. Web submits attestation to smart contract
2. Contract verifies signature against TEE public key
3. Contract verifies nonce (replay protection)
4. Contract updates on-chain state

---

## Agent Swarm in TEE

### Architect Agent

**Role**: Orchestrate challenge generation and coordinate specialist agents.

**Responsibilities:**
- Receive user's topic and stake
- Generate challenge brief using Cerebras AI
- Delegate to specialist agents for question generation
- Aggregate results and return to user

**Example Output:**
```typescript
{
  challengeId: "ch_solidity_001",
  brief: "This challenge tests your understanding of Solidity visibility modifiers",
  questions: [
    // Generated by specialist agents
  ],
  documentation: [
    "https://docs.soliditylang.org/...",
    "https://ethereum.org/en/..."
  ]
}
```

### Specialist Agents

**Role**: Generate specific types of questions in parallel.

**Types:**
1. **Knowledge Agent**: Tests conceptual understanding
2. **Code Analysis Agent**: Tests code reading ability
3. **Best Practices Agent**: Tests security awareness

**Parallel Execution:**
```
Architect
  ├─→ Knowledge Agent (Question 1)
  ├─→ Code Agent (Question 2)
  └─→ Best Practices Agent (Question 3)
     ↓
Aggregate Responses
```

**Resource Isolation**: Each specialist runs in separate enclave memory region.

### Signing Agent

**Role**: ECDSA signature generation for on-chain verification.

**Process:**
1. Receive grading result from specialist swarm
2. Calculate final score (0-100)
3. Generate nonce for replay protection
4. Construct EIP-712 typed data:
   ```typescript
   {
     user: "0x...",
     topic: "Solidity",
     score: 85,
     nonce: 1,
     deadline: 1709187600
   }
   ```
5. Sign with TEE private key
6. Return signature to frontend

**Security**: Private key never leaves enclave memory.

---

## Key Management

### Key Hierarchy

```
┌──────────────────────────────────────────────┐
│  Intel SGX Provisioning Service         │
│  (Intel-Generated Attestation Key)     │
└────────────────┬─────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────┐
│  Sealing Key (Enclave-Specific)        │
│  - Derived from SGX quote              │
│  - Same enclave can unseal            │
└────────────────┬─────────────────────┘
               │
               ▼
┌──────────────────────────────────────────────┐
│  TEE Signing Key                       │
│  - Generated on startup                  │
│  - Sealed to disk                      │
│  - Unsealed on each restart               │
│  - Public key exported                  │
└──────────────────────────────────────────────┘
```

### Key Generation (Startup)

```typescript
// Inside enclave
const { publicKey, privateKey } = generateKeyPair();
const sealedKey = sealToSGX(privateKey);

// Export public key (not sensitive)
const attestation = {
  publicKey: publicKey,
  sgxQuote: generateQuote(),
  version: 1
};

// Send to smart contract for enrollment
await contract.enrollTEE(publicKey, attestation);
```

### Key Persistence

- **Private Key**: Sealed to disk using SGX sealing key
- **Public Key**: Stored in smart contract (TEE_PUBLIC_KEY)
- **Unsealing**: Happens automatically on each enclave restart

**Benefit**: Enclave can be restarted without losing key, but key can never be extracted.

---

## Network Security

### Outbound Connections

TEE acts as client, initiating connections to:

1. **Cerebras AI API** (Challenge generation)
   - Endpoint: `https://api.cerebras.ai/v1/chat/completions`
   - Purpose: Generate challenge questions
   - Auth: API key sealed in enclave

2. **Sepolia RPC** (On-chain operations)
   - Endpoint: `https://eth-sepolia.g.alchemy.com/v2/...`
   - Purpose: Query contract state
   - Auth: None (read-only)

### Inbound Connections

**None**. TEE does not accept incoming connections. All communication is initiated by:

1. Frontend (HTTP POST to TEE endpoint)
2. Smart Contract (TEE calls contract functions)

### TLS Verification

- All outbound connections use TLS 1.3
- Certificate verification enabled in enclave
- Certificate pinning for Cerebras API

---

## Limitations & Trade-offs

### Memory Constraints

**SGX Enclave Page Cache (EPC)**: ~128MB per enclave

**Impact:**
- Can't load large AI models directly
- Must use external APIs (Cerebras)
- State must be minimal (per-request processing)

**Mitigation**:
- Stateless design (no persistent state between requests)
- Streaming responses (process chunks, discard immediately)

### No Persistent Storage

**Limitation**: Enclave cannot write to host filesystem securely.

**Impact**:
- All state stored in smart contract
- No local logging within enclave
- Keys must be sealed

**Mitigation**:
- Smart contract as source of truth
- Logging via untrusted host (sanitized)

### Cold Start Latency

**Issue**: First request after enclave restart takes ~2-3 seconds.

**Causes**:
- SGX quote generation (contact Intel IAS)
- Key unsealing
- Contract enrollment verification

**Mitigation**:
- Keep-enclave-alive (periodic health checks)
- Pre-warm before demo (health endpoint ping)

---

## Deployment on EigenCompute

### Docker Image

```dockerfile
FROM ubuntu:22.04

# Install SGX dependencies
RUN apt-get update && apt-get install -y \
  sgx-aesm-service \
  libsgx-urts \
  libsgx-uae-service

# Install Node.js
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
RUN apt-get install -y nodejs

# Install Gramine
RUN curl -fsSL https://packages.gramineproject.io/gpg -o /usr/share/keyrings/gramine-archive-keyring.gpg \
  && curl -fsSL https://packages.gramineproject.io/gpg > /usr/share/keyrings/gramine-archive-keyring.gpg \
  && gpg --no-default-keyring --keyring /usr/share/keyrings/gramine-archive-keyring.gpg --import /usr/share/keyrings/gramine-archive-keyring.gpg \
  && gpg --no-default-keyring --keyring /usr/share/keyrings/gramine-archive-keyring.gpg --export --armor 4DA6CFB3C448E22E \
  | apt-key add -

# Copy application
COPY src/tee /app/tee

# Copy manifest
COPY gramine.manifest.template /app/tee/manifest

# Start enclave
CMD ["/app/tee/server.js"]
```

### Gramine Manifest Template

```toml
libos.entrypoint = "/app/tee/server.js"

# Trust Cerebras API
sgx.trusted_files = [
    "file:/etc/ssl/certs/ca-certificates.crt"
]

# Allow network
sgx.allowed_files = [
    "file:/dev/urandom"
]

# Heap size (128MB EPC limit)
sgx.heap_size = "128M"

# Stack size
sgx.stack_size = "8M"
```

---

## Monitoring & Health

### Health Check Endpoint

**GET** `/health`

**Response:**
```json
{
  "status": "operational",
  "uptime": 3600,
  "requests_processed": 1234,
  "enclave_initialized": true,
  "attestation_valid": true
}
```

### Metrics to Track

| Metric | Threshold | Action |
|---------|-----------|---------|
| Request latency | > 5 seconds | Investigate enclave restart |
| Error rate | > 5% | Check Cerebras API status |
| Attestation failures | > 1% | Verify SGX quote validity |
| Memory usage | > 90% EPC | Optimize agent code |

---

## Future Enhancements

1. **Multi-TEE Architecture**: Run multiple enclaves for redundancy
2. **Zero-Knowledge Proofs**: Replace SGX attestation with ZK proofs
3. **Local AI Models**: Run small models directly in enclave (reduces latency)
4. **Hardware Key Store**: Use Intel PCK service for key sealing
